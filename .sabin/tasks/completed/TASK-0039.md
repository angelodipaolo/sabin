---
status: completed
title: Expand test coverage across all packages
---
## Overview

Based on the architectural review, test coverage is critically low at ~12% (2 test files for 17 TypeScript files). The VS Code extension has zero tests, and several core modules lack coverage.

## Current State

- **@sabin/core**: 1 test file (markdown.test.ts) - missing tests for config.ts, errors.ts
- **@sabin/cli**: 1 test file (commands.test.ts) - decent coverage but missing edge cases
- **sabin-vscode**: 0 test files - no coverage for extension, providers, services, or watchers
- **Integration tests**: Outdated (still using 'ticket' terminology instead of 'task')

## Requirements

### Phase 1: Critical Coverage (Priority: HIGH)

#### 1. @sabin/core Package Tests

**File: packages/core/src/__tests__/config.test.ts**
- Test `readConfig()` with missing config file (should return defaults)
- Test `readConfig()` with partial config (should merge with defaults)
- Test `readConfig()` with invalid JSON (should handle gracefully)
- Test `writeConfig()` creates proper JSON structure
- Test `getDefaultConfig()` returns expected defaults

**File: packages/core/src/__tests__/errors.test.ts**
- Test `SabinError` constructor and error codes
- Test `TaskNotFoundError` message formatting
- Test `InvalidTaskStatusError` message formatting
- Test `isValidStatus()` with all valid statuses including 'in_progress'
- Test `isValidStatus()` with invalid statuses
- Test `handleError()` output formatting

#### 2. VS Code Extension Tests

**File: packages/vscode-extension/src/__tests__/taskService.test.ts**
- Test `getInstance()` singleton pattern
- Test `createTask()` with auto-generated ID
- Test `createTask()` with custom ID
- Test `createTask()` duplicate detection (both open/ and resolved/)
- Test `updateTaskStatus()` updates frontmatter correctly
- Test `updateTaskStatus()` moves file from open to resolved
- Test `updateTaskStatus()` moves file from resolved to open
- Test `getTasks()` returns all tasks
- Test `getTasks()` filters by status
- Test `deleteTask()` removes file
- Test `getNextTaskNumber()` increments correctly
- Test `getNextTaskNumber()` respects custom prefix

**File: packages/vscode-extension/src/__tests__/fileWatcher.test.ts**
- Test debouncing behavior on file changes
- Test separate debounce timers for changes vs renames
- Test disposal cleans up watchers and timers

#### 3. Integration Tests Update

**File: tests/integration/workflow.test.ts**
- Update all references from 'ticket' to 'task'
- Update paths from `.sabin/tickets/` to `.sabin/tasks/`
- Update task IDs from TICKET-#### to TASK-####
- Add test for custom task prefix configuration
- Add test for external task IDs (e.g., JIRA-123)

### Phase 2: Enhanced Coverage (Priority: MEDIUM)

#### 4. CLI Edge Cases

**File: packages/cli/src/__tests__/commands.test.ts** (expand existing)
- Test `createTask` with special characters in title (colons, quotes, brackets)
- Test `createTask` with very long titles/content
- Test `updateStatus` with task in resolved moving back to open
- Test `listTasks` with custom prefix tasks
- Test error handling when .sabin directory doesn't exist

#### 5. Core Package Edge Cases

**File: packages/core/src/__tests__/markdown.test.ts** (expand existing)
- Test `parseTask()` with malformed YAML frontmatter
- Test `parseTask()` with missing required fields
- Test `writeTask()` with special characters in frontmatter values
- Test `getNextTaskNumber()` with mixed prefixes in directory
- Test `getNextTaskNumber()` with gaps in numbering

### Phase 3: Webview Testing (Priority: LOW)

#### 6. Webview Provider Tests

**File: packages/vscode-extension/src/__tests__/webviewProvider.test.ts**
- Test webview HTML generation
- Test message handling from webview (createTask, updateStatus, deleteTask)
- Test refresh behavior
- Test status dropdown interaction
- Test resolved view toggle

## Testing Infrastructure Setup

### Dependencies to Add

```bash
# For VS Code extension testing
cd packages/vscode-extension
npm install --save-dev @vscode/test-electron jest ts-jest @types/jest

# Configure jest.config.js for VS Code environment
```

### Coverage Targets

- **Phase 1 completion**: 50% overall coverage
- **Phase 2 completion**: 70% overall coverage
- **Phase 3 completion**: 85%+ overall coverage

### Run Coverage Reports

```bash
# Add to package.json scripts
"test:coverage": "lerna run test -- --coverage"
```

## Acceptance Criteria

- [ ] All Phase 1 tests implemented and passing
- [ ] Integration tests updated to use 'task' terminology
- [ ] Coverage report shows 50%+ line coverage
- [ ] All existing tests still pass
- [ ] No test flakiness (tests pass consistently)
- [ ] Test documentation added to README or TESTING.md

## Known Bugs to Fix During Testing

1. **TaskProvider workspaceRoot bug**: packages/vscode-extension/src/providers/taskProvider.ts:26 references undefined property
2. **Status validation missing in_progress**: packages/core/src/errors.ts:46 needs to include 'in_progress'
3. **Hardcoded TASK prefix**: packages/cli/src/commands/list-tasks.ts:86 should use config

## Notes

- Use `@vscode/test-electron` for VS Code extension integration tests
- Mock file system operations where appropriate
- Test both happy paths and error cases
- Ensure tests clean up temporary files
- Follow existing test patterns in markdown.test.ts and commands.test.ts
