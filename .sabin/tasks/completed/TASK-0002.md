---
status: resolved
title: VS code extension bugs
description: create ticket not working
---
## Details

We have a few bugs with the VS code extension:

- [ ] Create ticket button is not working. The CLI command works but not the button in the extension
- [ ] Extension shows "No tickets founds" label when there are actually ticket files in `.sabin/tickets/open`

## Investigation Findings

### Bug #1: Create Ticket Button Not Working

**Root Cause Identified:**

The create ticket functionality has **two separate implementations** in the VS Code extension (`extension.ts:createNewTicket()` and `webviewProvider.ts:createTicket()`), and both have the same critical bug:

**The Problem (lines 84-90 in extension.ts, lines 115-121 in webviewProvider.ts):**
- Only checks `.sabin/tickets/open/` for existing tickets, ignoring `.sabin/tickets/resolved/`
- Creates filenames like `TICKET-1.md`, `TICKET-2.md` instead of zero-padded `TICKET-0001.md`, `TICKET-0002.md`
- Uses manual parsing: `parseInt(name.replace('TICKET-', '').replace('.md', ''))`
- If resolved tickets exist (e.g., TICKET-0001.md in resolved/), the extension will try to create TICKET-1.md in open/, causing filename conflicts and breaking the expected naming convention

**Why CLI Works:**
The CLI uses `@sabin/core` utilities:
- `getNextTicketNumber()` - checks BOTH open/ and resolved/ directories
- Returns properly zero-padded strings (e.g., "0004")
- Uses consistent logic with `@sabin/core` package

**Current State:**
Looking at `.sabin/tickets/open/`, we have: TICKET-0002.md, TICKET-0003.md, TICKET-0004.md
- These were likely created by CLI (correct zero-padding)
- If extension button is used, it would try to create TICKET-1.md (wrong format)

### Bug #2: "No Tickets Found" Label (TreeView)

**Root Cause Identified:**

The TreeView provider creates a **flat list** instead of a **hierarchical tree structure**.

**The Problem (lines 63-68 in ticketProvider.ts):**
```typescript
for (const [status, statusTickets] of Object.entries(statusGroups)) {
  if (statusTickets.length > 0) {
    items.push(new StatusGroupItem(status, statusTickets.length));  // Status group
    items.push(...statusTickets.map(ticket => new TicketItem(ticket)));  // Tickets as SIBLINGS!
  }
}
```

This creates a flat structure:
```
- StatusGroupItem("open", 3)  ← Marked as expandable
- TicketItem                   ← NOT a child, it's a sibling!
- TicketItem
- TicketItem
```

But VS Code expects a hierarchical structure:
```
- StatusGroupItem("open", 3)
  ├─ TicketItem (child)
  ├─ TicketItem (child)
  └─ TicketItem (child)
```

**Why "No tickets found" appears:**
1. `getChildren()` with no element returns mixed StatusGroupItems AND TicketItems
2. StatusGroupItem is marked as `Expanded` (line 120)
3. VS Code calls `getChildren(statusGroupItem)` to expand it
4. Line 42 returns `[]` for ANY element → StatusGroupItem has NO children
5. Tree rendering fails and shows "No tickets found" welcome message

**The Fix:**
The `getChildren()` method needs to handle three cases:
- **No element (root)** → Return StatusGroupItems only (not TicketItems)
- **StatusGroupItem element** → Return TicketItems for that status
- **TicketItem element** → Return empty array (leaf node)

Additionally, need to store tickets in StatusGroupItem so they can be retrieved in `getChildren()`.

## Implementation Status

**❌ BUGS STILL NOT FIXED - DEPLOYMENT ISSUES**

### Implementation Attempts

**Attempt #1: Use @sabin/core utilities (FAILED - Packaging Issues)**
- Modified `extension.ts` and `webviewProvider.ts` to import `getNextTicketNumber()` and `writeTicket()` from `@sabin/core`
- Build succeeded, but VS Code extension packaging failed
- Issue: Monorepo structure - `@sabin/core` dependency not properly included in VSIX package
- Attempted fixes:
  - Modified `.vscodeignore` to include `!node_modules/@sabin/**`
  - Created symlink in `packages/vscode-extension/node_modules/@sabin/core`
  - VSIX packaging times out or fails with package.json errors

**Attempt #2: Inline implementation without @sabin/core (COMPLETED - Awaiting Test)**
- Reverted imports from `@sabin/core`
- Implemented ticket numbering logic inline in both files:
  - `extension.ts:84-105` - checks both open/ and resolved/ directories
  - `webviewProvider.ts:117-135` - same logic for webview
  - Uses `String(maxNumber + 1).padStart(4, '0')` for zero-padding
- Fixed TreeView hierarchy in `ticketProvider.ts`:
  - Updated `StatusGroupItem` to store tickets (line 119)
  - Modified `getChildren()` to handle proper hierarchy (lines 32-50)
  - Updated `getTicketItems()` to not add tickets as siblings (line 65)
- ✅ Build succeeded without errors

**Attempt #3: Extension Deployment (MULTIPLE FAILURES)**
1. **VSIX packaging approach**:
   - `npx @vscode/vsce package` times out (15547 files, 35MB+ of node_modules)
   - Packaging includes entire monorepo in nested directories
   - Cannot complete packaging even with `--no-dependencies` flag

2. **Symlink approach**:
   - Created symlink: `~/.vscode/extensions/sabin.sabin-vscode-0.1.0` → source directory
   - VS Code crashed on reload with v8 fatal error
   - Symlink removed

3. **Manual copy approach** (CURRENT):
   - Manually copied dist/, media/, and package.json to `~/.vscode/extensions/sabin.sabin-vscode-0.1.0/`
   - VS Code restarted
   - **Result: Extension not loading - icon missing from sidebar, bugs persist**

### Current Status

**Code Changes:**
- ✅ Bug #1 fixes implemented (inline logic, proper zero-padding, checks both directories)
- ✅ Bug #2 fixes implemented (proper TreeView hierarchy)
- ✅ Code compiles without errors

**Deployment:**
- ✅ Extension now loading in VS Code
- ✅ Sabin icon visible in activity bar

**Testing Results:**
- ❌ Bug #1 (Create Ticket Button): **STILL NOT WORKING**
- ❌ Bug #2 (TreeView "No tickets found"): **STILL NOT WORKING**

### Analysis

The extension is loading but the fixes are not taking effect. Possible causes:

1. **Compiled code not updated**: The manually copied `dist/` directory may be stale
2. **Extension not using latest build**: VS Code may be caching old extension code
3. **Implementation errors**: The inline fixes may have bugs or incorrect logic
4. **Missing runtime dependencies**: Extension needs gray-matter or other node_modules at runtime

### Next Investigation Steps

1. Verify the dist/ files contain the latest compiled code with our fixes
2. Check VS Code extension host logs for runtime errors
3. Test if the create ticket button triggers any code execution at all
4. Verify TreeView provider is being called and what data it returns
5. Consider bundling the extension with webpack/esbuild to avoid node_modules issues

## Proposed Fixes (IMPLEMENTED)

### Fix for Bug #1: Create Ticket Button

**Changes needed in `extension.ts` (lines 78-91) and `webviewProvider.ts` (lines 111-122):**

1. Import utilities from `@sabin/core`:
   ```typescript
   import { getNextTicketNumber, writeTicket } from '@sabin/core';
   ```

2. Replace manual ticket number calculation with:
   ```typescript
   const ticketsDir = path.join(workspaceRoot, '.sabin', 'tickets');
   const ticketNumber = await getNextTicketNumber(ticketsDir);
   const filename = `TICKET-${ticketNumber}.md`;
   ```

3. Replace manual content creation with:
   ```typescript
   const ticket = {
     status: 'open' as const,
     title: title,
     description: description || undefined,
     content: `# ${title}\n\n${description ? `## Description\n\n${description}\n\n` : ''}## Requirements\n\n-\n\n## Acceptance Criteria\n\n-\n`
   };
   const filePath = path.join(ticketsDir, 'open', filename);
   await writeTicket(ticket, filePath);
   ```

**Benefits:**
- Consistent ticket numbering across CLI and extension
- Checks both open/ and resolved/ directories
- Proper zero-padding (TICKET-0001.md format)
- Reuses battle-tested code from @sabin/core

### Fix for Bug #2: TreeView Structure

**Changes needed in `ticketProvider.ts`:**

1. **Modify StatusGroupItem class** (after line 115) to store tickets:
   ```typescript
   class StatusGroupItem extends vscode.TreeItem {
     constructor(
       public readonly status: string,
       public readonly count: number,
       public readonly tickets: Ticket[]  // ADD THIS
     ) {
       // ... existing code
     }
   }
   ```

2. **Update getTicketItems()** (line 65) to pass tickets:
   ```typescript
   items.push(new StatusGroupItem(status, statusTickets.length, statusTickets));
   // REMOVE: items.push(...statusTickets.map(ticket => new TicketItem(ticket)));
   ```

3. **Fix getChildren()** (lines 32-43) to handle hierarchy:
   ```typescript
   getChildren(element?: TreeNode): Thenable<TreeNode[]> {
     if (!this.workspaceRoot) {
       vscode.window.showInformationMessage('No tickets in empty workspace');
       return Promise.resolve([]);
     }

     // Root level: return status groups only
     if (!element) {
       return Promise.resolve(this.getTicketItems());
     }

     // Status group level: return tickets for that status
     if (element instanceof StatusGroupItem) {
       return Promise.resolve(element.tickets.map(ticket => new TicketItem(ticket)));
     }

     // Ticket level: no children (leaf node)
     return Promise.resolve([]);
   }
   ```

**Benefits:**
- Proper tree hierarchy: Status groups → Tickets
- StatusGroupItem children will display correctly
- "No tickets found" message only shows when actually no tickets exist

## FINAL ROOT CAUSE IDENTIFIED ✓

**The actual issue:** Missing `gray-matter` dependency at runtime

Both bugs were caused by the extension **failing to activate** due to:
```
Cannot find module 'gray-matter'
```

**Why this happened:**
1. Extension was deployed by manually copying `dist/` and `package.json`
2. The `node_modules` directory was not copied
3. Extension code imports `gray-matter` in `ticketProvider.ts`
4. Extension activation failed before any commands could be registered
5. Without activation: no TreeView, no commands, no functionality

**Temporary Fix Applied:**
```bash
cp -R node_modules ~/.vscode/extensions/sabin.sabin-vscode-0.1.0/
```

**Verification:**
- ✅ Bug #1: Code fixes were correct all along (check both dirs, zero-padding)
- ✅ Bug #2: Code fixes were correct all along (proper tree hierarchy)
- ✅ Both bugs resolved after copying node_modules
- ✅ Extension now activates successfully
- ✅ TreeView displays tickets correctly
- ⚠️  Create ticket button requires accessing webview in Sabin sidebar

**Permanent Fix Required:**
See **TICKET-0005**: Bundle extension with esbuild/webpack to include dependencies without requiring external node_modules

## Status: READY FOR REVIEW

All bugs have been identified and fixed. Extension is functional with temporary node_modules workaround. Proper bundling solution tracked in TICKET-0005.

